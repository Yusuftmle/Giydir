@page "/profile"
@inject HttpClient Http
@inject ILogger<Profile> Logger
@rendermode InteractiveServer

@code {
    private Giydir.Core.DTOs.UserDto? currentUser;
    private bool isLoading = true;
    private bool isSaving = false;
    private string? successMessage;
    private string? errorMessage;

    // Form alanları
    private string name = string.Empty;
    private string title = string.Empty;
    private string email = string.Empty;
    private string boutiqueName = string.Empty;
    private string sector = string.Empty;
    private string websiteUrl = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // AuthTokenHandler token'ı otomatik ekler (cookie/session'dan)
        await LoadProfileAsync();
    }

    private async Task LoadProfileAsync()
    {
        try
        {
            isLoading = true;
            var response = await Http.GetFromJsonAsync<Giydir.Core.DTOs.AuthResponseDto>("api/auth/me");
            if (response?.Success == true && response.User != null)
            {
                currentUser = response.User;
                name = currentUser.Name ?? string.Empty;
                title = currentUser.Title ?? string.Empty;
                email = currentUser.Email;
                boutiqueName = currentUser.BoutiqueName ?? string.Empty;
                sector = currentUser.Sector ?? string.Empty;
                websiteUrl = currentUser.WebsiteUrl ?? string.Empty;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Profile] Profil yükleme hatası");
            errorMessage = "Profil bilgileri yüklenemedi.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSave()
    {
        if (isSaving) return;

        isSaving = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            // AuthTokenHandler token'ı otomatik ekler
            var dto = new Giydir.Core.DTOs.UpdateProfileDto
            {
                Name = name,
                Title = title,
                BoutiqueName = boutiqueName,
                Sector = sector,
                WebsiteUrl = websiteUrl
            };

            var response = await Http.PutAsJsonAsync("api/auth/profile", dto);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<Giydir.Core.DTOs.AuthResponseDto>();
                if (result?.Success == true && result.User != null)
                {
                    currentUser = result.User;
                    successMessage = "Profil başarıyla güncellendi!";
                    Logger.LogInformation("[Profile] Profil güncellendi");
                }
                else
                {
                    errorMessage = result?.Error ?? "Profil güncellenemedi.";
                }
            }
            else
            {
                errorMessage = "Profil güncellenemedi. Lütfen tekrar deneyin.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Profile] Profil kaydetme hatası");
            errorMessage = "Bir hata oluştu. Lütfen tekrar deneyin.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void HandleCancel()
    {
        // Form alanlarını orijinal değerlere geri döndür
        if (currentUser != null)
        {
            name = currentUser.Name ?? string.Empty;
            title = currentUser.Title ?? string.Empty;
            email = currentUser.Email;
            boutiqueName = currentUser.BoutiqueName ?? string.Empty;
            sector = currentUser.Sector ?? string.Empty;
            websiteUrl = currentUser.WebsiteUrl ?? string.Empty;
        }
        successMessage = null;
        errorMessage = null;
    }

    private string GetInitials()
    {
        if (!string.IsNullOrEmpty(name))
        {
            var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2)
                return $"{parts[0][0]}{parts[1][0]}".ToUpper();
            if (parts.Length == 1)
                return parts[0][..Math.Min(2, parts[0].Length)].ToUpper();
        }
        if (!string.IsNullOrEmpty(email))
            return email[..Math.Min(2, email.Length)].ToUpper();
        return "?";
    }
}

<div class="flex min-h-[calc(100vh-5rem)]">
    <!-- Sidebar Navigation -->
    <aside class="w-64 hidden lg:flex flex-col border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-surface-dark">
        <nav class="flex-1 px-4 py-6 space-y-1">
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary transition-colors group no-underline" href="/profile">
                <span class="material-icons-outlined text-[20px]">person</span>
                <span class="font-medium text-sm">Profil</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white transition-colors group no-underline" href="/settings">
                <span class="material-icons-outlined text-[20px] group-hover:text-primary transition-colors">credit_card</span>
                <span class="font-medium text-sm">Faturalandırma & Planlar</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white transition-colors group no-underline" href="#">
                <span class="material-icons-outlined text-[20px] group-hover:text-primary transition-colors">vpn_key</span>
                <span class="font-medium text-sm">API Anahtarları</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white transition-colors group no-underline" href="/notifications">
                <div class="relative">
                    <span class="material-icons-outlined text-[20px] group-hover:text-primary transition-colors">notifications</span>
                    <span class="absolute top-0 right-0 w-2 h-2 bg-primary rounded-full"></span>
                </div>
                <span class="font-medium text-sm">Bildirimler</span>
            </a>
            <div class="pt-4 mt-4 border-t border-slate-200 dark:border-slate-700">
                <p class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Takım</p>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white transition-colors no-underline" href="#">
                    <span class="material-icons-outlined text-[20px]">groups</span>
                    <span class="font-medium text-sm">Üyeler</span>
                </a>
            </div>
        </nav>
        <!-- User Info -->
        <div class="p-4 border-t border-slate-200 dark:border-slate-800">
            <div class="flex items-center gap-3 p-2 rounded-lg">
                <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-primary/30 bg-primary/20 flex items-center justify-center">
                    <span class="text-primary font-bold text-sm">@GetInitials()</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-slate-900 dark:text-white truncate m-0">@(string.IsNullOrEmpty(name) ? "Kullanıcı" : name)</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 truncate m-0">@email</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 p-6 lg:p-10 max-w-7xl mx-auto w-full space-y-12">
        <!-- Header -->
        <div>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Kullanıcı Profili</h1>
            <p class="text-slate-500 dark:text-slate-400">Kişisel bilgilerinizi ve butik detaylarınızı yönetin.</p>
        </div>

        @if (isLoading)
        {
            <div class="flex items-center justify-center py-20">
                <div class="flex flex-col items-center gap-3">
                    <div class="w-8 h-8 border-3 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-slate-400 text-sm">Profil yükleniyor...</p>
                </div>
            </div>
        }
        else
        {
            <!-- Success/Error Messages -->
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="p-4 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm flex items-center gap-2">
                    <span class="material-icons-outlined text-lg">check_circle</span>
                    @successMessage
                </div>
            }
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm flex items-center gap-2">
                    <span class="material-icons-outlined text-lg">error</span>
                    @errorMessage
                </div>
            }

            <!-- Profile Card -->
            <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/50 rounded-xl shadow-sm overflow-hidden">
                <div class="p-8 border-b border-slate-200 dark:border-slate-700/50">
                    <div class="flex flex-col md:flex-row gap-8">
                        <!-- Avatar Section -->
                        <div class="flex-shrink-0">
                            <div class="relative group cursor-pointer">
                                <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-white dark:border-surface-dark shadow-lg ring-2 ring-slate-200 dark:ring-slate-700 bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center">
                                    <span class="text-white font-bold text-4xl">@GetInitials()</span>
                                </div>
                                <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="material-icons-outlined text-white">camera_alt</span>
                                </div>
                                <button class="absolute bottom-0 right-0 p-2 bg-primary text-white rounded-full shadow-lg border-2 border-white dark:border-surface-dark hover:bg-primary/90 transition-colors">
                                    <span class="material-icons-outlined text-sm">edit</span>
                                </button>
                            </div>
                            <p class="mt-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 m-0">İzin verilen: *.jpeg, *.jpg, *.png, *.gif <br/> maksimum 3 MB</p>
                        </div>

                        <!-- Form Section -->
                        <div class="flex-1 space-y-8">
                            <!-- Personal Information -->
                            <div>
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                    <span class="material-icons-outlined text-primary">person</span>
                                    Kişisel Bilgiler
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Ad Soyad</label>
                                        <input @bind="name" @bind:event="oninput" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white text-sm" type="text" placeholder="Adınız Soyadınız" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Mesleki Unvan</label>
                                        <input @bind="title" @bind:event="oninput" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white text-sm" type="text" placeholder="Moda Butik Sahibi" />
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">E-posta Adresi</label>
                                        <div class="relative">
                                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="material-icons-outlined text-slate-400 text-sm">email</span>
                                            </span>
                                            <input value="@email" disabled class="w-full pl-10 px-4 py-2.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg text-slate-500 dark:text-slate-400 text-sm cursor-not-allowed" type="email" />
                                        </div>
                                        <p class="mt-1 text-xs text-slate-400">E-posta adresi değiştirilemez.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Boutique Details -->
                            <div class="pt-6 border-t border-slate-200 dark:border-slate-700/50">
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                    <span class="material-icons-outlined text-primary">storefront</span>
                                    Butik Detayları
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Butik Adı</label>
                                        <input @bind="boutiqueName" @bind:event="oninput" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white text-sm" type="text" placeholder="Butik adınız" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Sektör</label>
                                        <select @bind="sector" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white text-sm">
                                            <option value="">Seçiniz...</option>
                                            <option value="Kadın Modası">Kadın Modası</option>
                                            <option value="Erkek Modası">Erkek Modası</option>
                                            <option value="Lüks Ürünler">Lüks Ürünler</option>
                                            <option value="Vintage & İkinci El">Vintage & İkinci El</option>
                                            <option value="Spor Giyim">Spor Giyim</option>
                                            <option value="Çocuk Giyim">Çocuk Giyim</option>
                                            <option value="Diğer">Diğer</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Web Sitesi URL</label>
                                        <div class="relative">
                                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="material-icons-outlined text-slate-400 text-sm">link</span>
                                            </span>
                                            <input @bind="websiteUrl" @bind:event="oninput" class="w-full pl-10 px-4 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-slate-900 dark:text-white text-sm" type="url" placeholder="https://siteniz.com" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="px-8 py-5 bg-slate-50 dark:bg-slate-900/50 flex items-center justify-end gap-3 border-t border-slate-200 dark:border-slate-700/50">
                    <button @onclick="HandleCancel" class="px-6 py-2.5 text-sm font-semibold text-slate-700 dark:text-slate-300 bg-white dark:bg-surface-dark border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                        İptal
                    </button>
                    <button @onclick="HandleSave" disabled="@isSaving" class="px-6 py-2.5 text-sm font-bold text-background-dark bg-primary rounded-lg hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        @if (isSaving)
                        {
                            <div class="w-4 h-4 border-2 border-background-dark border-t-transparent rounded-full animate-spin"></div>
                            <span>Kaydediliyor...</span>
                        }
                        else
                        {
                            <span>Değişiklikleri Kaydet</span>
                        }
                    </button>
                </div>
            </div>
        }
    </div>
</div>
