@page "/editor"
@using Giydir.Core.Entities
@using Giydir.Core.DTOs
@using Giydir.Core.Interfaces
@using Giydir.Infrastructure.Services
@inject IProjectRepository ProjectRepository
@inject IGeneratedImageRepository ImageRepository
@inject IImageDownloadService ImageDownloader
@inject IJwtTokenService JwtService
@inject HttpClient Http
@inject RenderOrchestrator Orchestrator
@inject IAIImageGenerationService GenService
@inject IModelAssetRepository ModelAssetRepository
@inject IPoseRepository PoseRepository
@inject ILogger<Editor> Logger
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="relative flex h-screen w-full flex-col overflow-hidden bg-background-light dark:bg-background-dark text-white font-display">

    <main class="flex flex-1 overflow-hidden">
        <!-- Left Panel: Scene Vibes & Selectors -->
        <aside class="w-[320px] border-r border-neutral-700 bg-background-dark flex flex-col custom-scrollbar overflow-y-auto z-20">
            <div class="p-6 space-y-8">
                
                <!-- Garment Upload Section -->
                 <section>
                    <h3 class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-4">Kıyafet Kaynağı</h3>
                    <div class="relative group cursor-pointer">
                        <div class="relative bg-neutral-800 border-2 border-dashed border-neutral-700 rounded-xl p-6 flex flex-col items-center text-center hover:border-primary/50 transition-colors">
                            @if (string.IsNullOrEmpty(uploadedClothingUrl))
                            {
                                <span class="material-symbols-outlined text-3xl font-light text-neutral-400 mb-2">add_photo_alternate</span>
                                <p class="text-[10px] font-bold text-neutral-300 uppercase tracking-wider">Kıyafet Yükle</p>
                                <InputFile OnChange="HandleClothingUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/jpeg,image/png,image/webp" />
                            }
                            else
                            {
                                <img src="@uploadedClothingUrl" class="h-24 object-contain rounded-lg mb-2" alt="Uploaded" />
                                <button class="text-[10px] text-red-400 hover:text-red-300 uppercase tracking-wider z-10 relative" @onclick="ClearClothing">Kaldır</button>
                            }
                        </div>
                    </div>
                </section>

                <!-- Model Selection -->
                <section>
                     <h3 class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-4">Sanal Model</h3>
                     <ModelSelector @bind-SelectedModelId="selectedModelId" />
                </section>

                <!-- Scene Vibes Section -->
                <section>
                    <h3 class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-4">Arka Plan</h3>
                    <div class="grid grid-cols-1 gap-3">
                        @foreach (var vibe in vibeOptions)
                        {
                            <div class="group relative aspect-[16/9] rounded-lg overflow-hidden cursor-pointer border-2 @(selectedBackground == vibe.Key ? "border-primary" : "border-transparent hover:border-neutral-600")" 
                                 @onclick="() => selectedBackground = vibe.Key">
                                <div class="absolute inset-0" style="@vibe.Value"></div>
                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end p-3">
                                    <div class="flex justify-between items-center w-full">
                                        <span class="text-xs font-medium tracking-wider text-white">@vibe.Key</span>
                                        @if(selectedBackground == vibe.Key) { <span class="material-symbols-outlined text-primary text-sm">check_circle</span> }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </section>

                <!-- Pose Section -->
                <section>
                    <h3 class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-4">Poz</h3>
                    <div class="grid grid-cols-2 gap-2">
                        @foreach (var pose in loadedPoses)
                        {
                            <button class="relative rounded-lg border overflow-hidden @(selectedPose == pose.Name ? "border-primary ring-1 ring-primary" : "border-neutral-700 hover:border-neutral-600") transition-all"
                                    @onclick="() => selectedPose = pose.Name">
                                <div class="aspect-[3/4] bg-neutral-800">
                                    @if (!string.IsNullOrEmpty(pose.ImagePath))
                                    {
                                        <img src="@pose.ImagePath" class="w-full h-full object-cover" alt="@pose.Name" />
                                    }
                                    else
                                    {
                                        <div class="w-full h-full flex items-center justify-center">
                                            <span class="material-symbols-outlined text-2xl text-neutral-600">accessibility_new</span>
                                        </div>
                                    }
                                </div>
                                <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                    <span class="text-[10px] font-bold uppercase tracking-wider @(selectedPose == pose.Name ? "text-primary" : "text-neutral-300")">@pose.Name</span>
                                </div>
                            </button>
                        }
                    </div>
                </section>

                <!-- Dropdowns Section -->
                <section class="space-y-6">
                    <div>
                        <label class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-3 block">Kategori</label>
                        <select @bind="selectedCategory" class="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-sm text-white outline-none focus:border-primary uppercase tracking-wider">
                            <option value="upper_body">Dış Giyim</option>
                            <option value="lower_body">Pantolon</option>
                            <option value="dresses">Gece Kıyafeti</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-3 block">Aydınlatma</label>
                         <select @bind="selectedLighting" class="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-sm text-white outline-none focus:border-primary uppercase tracking-wider">
                            <option value="Golden Hour">Altın Saat</option>
                            <option value="Studio Soft">Stüdyo Işığı</option>
                            <option value="Dramatic">Dramatik Kontrast</option>
                        </select>
                    </div>
                </section>
            </div>
            
            <!-- Generate Button -->
            <div class="mt-auto p-6 border-t border-neutral-700 space-y-3">
                <!-- Variation Count Selector -->
                <div class="flex items-center justify-between mb-2">
                    <label class="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Varyasyon</label>
                    <div class="flex bg-neutral-800 rounded-lg p-1 border border-neutral-700">
                        @for (int i = 1; i <= 4; i++)
                        {
                            var count = i;
                            <button class="w-8 h-8 rounded flex items-center justify-center text-xs font-bold transition-all @(variationCount == count ? "bg-primary text-background-dark shadow-md" : "text-neutral-500 hover:text-white hover:bg-white/5")"
                                    @onclick="() => variationCount = count">
                                @count
                            </button>
                        }
                    </div>
                </div>

                @if (isProcessing)
                {
                    <div class="flex items-center justify-center gap-2 bg-primary/10 px-3 py-2 rounded-lg border border-primary/20 mb-2">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                        </span>
                        <span class="text-primary text-[10px] font-bold tracking-widest uppercase">Oluşturuluyor...</span>
                    </div>
                }
                <button class="w-full bg-primary text-background-dark font-bold text-sm tracking-widest uppercase py-4 rounded-lg flex items-center justify-center gap-2 hover:brightness-110 transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
                        @onclick="GenerateImage"
                        disabled="@(!CanGenerate)">
                    <span class="material-symbols-outlined">auto_fix_high</span>
                    <span>@variationCount Varyasyon Oluştur</span>
                </button>
            </div>
        </aside>

        <!-- Central Canvas: Editorial Grid -->
        <section class="flex-1 bg-[#0a1416] relative flex items-center justify-center p-12 overflow-hidden">
            <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: radial-gradient(circle at center, #13c8ec 0%, transparent 70%);"></div>
            
             @if (generatedImages.Any())
             {
                 <div class="grid grid-cols-2 gap-4 max-w-5xl w-full">
                     @for (int i = 0; i < generatedImages.Count; i++)
                     {
                         var idx = i;
                         var img = generatedImages[idx];
                         var isSelected = selectedImageIndices.Contains(idx);
                          <div class="aspect-[3/4] bg-neutral-800 rounded-lg overflow-hidden shadow-2xl border-2 @(isSelected ? "border-primary" : "border-white/5") hover:scale-[1.02] transition-all duration-300 cursor-pointer group relative"
                               @onclick="() => ToggleImageSelection(idx)">
                            <img class="w-full h-full object-cover" src="@img" />
                            <!-- Selection Checkbox -->
                            <div class="absolute top-3 right-3 z-10">
                                <div class="w-6 h-6 rounded-md border-2 @(isSelected ? "bg-primary border-primary" : "border-white/40 bg-black/40 backdrop-blur-sm group-hover:border-white/70") flex items-center justify-center transition-all">
                                    @if (isSelected)
                                    {
                                        <span class="material-symbols-outlined text-background-dark text-sm font-bold">check</span>
                                    }
                                </div>
                            </div>
                            <!-- Asset Label -->
                            <div class="absolute top-3 left-3 bg-black/40 backdrop-blur-md px-2 py-1 rounded text-[10px] tracking-tighter uppercase font-bold text-primary border border-primary/20">Asset_0@(idx+1)</div>
                        </div>
                     }
                 </div>
                 
                 <!-- Selection Count -->
                 @if (selectedImageIndices.Any())
                 {
                     <div class="absolute top-6 left-1/2 -translate-x-1/2 bg-primary/10 backdrop-blur-xl border border-primary/30 px-4 py-2 rounded-full z-50">
                         <span class="text-primary text-xs font-bold tracking-widest uppercase">@selectedImageIndices.Count seçili</span>
                     </div>
                 }
             }
             else if (isProcessing)
             {
                  <div class="flex flex-col items-center justify-center">
                    <div class="w-24 h-24 mb-6 relative">
                        <div class="absolute inset-0 border-2 border-primary/30 rounded-full animate-ping"></div>
                        <div class="relative w-full h-full bg-background-dark/80 rounded-full flex items-center justify-center backdrop-blur-sm border border-primary/20">
                            <span class="material-symbols-outlined text-primary text-4xl font-light animate-pulse">auto_fix_high</span>
                        </div>
                    </div>
                     <h4 class="text-sm font-display font-bold text-white tracking-[0.15em] uppercase mb-2">Koleksiyon Hazırlanıyor</h4>
                     <p class="text-[10px] text-neutral-500 max-w-[240px] leading-relaxed uppercase tracking-widest font-medium text-center">AI moda setinizi oluşturuyor</p>
                </div>
             }
             else
             {
                 <!-- Empty State -->
                 <div class="text-center opacity-40">
                      <span class="material-symbols-outlined text-6xl text-neutral-600 mb-4">view_quilt</span>
                       <h3 class="text-xl font-bold text-neutral-400 uppercase tracking-widest">Oluşturmaya Hazır</h3>
                       <p class="text-xs text-neutral-500 mt-2">Koleksiyonunuzu oluşturmak için kıyafet ve model seçin</p>
                 </div>
             }

            <!-- Floating Toolbar -->
            @if (generatedImages.Any())
            {
                <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-neutral-800/80 backdrop-blur-xl border border-neutral-700 p-2 rounded-full shadow-2xl z-50">
                    <button class="p-3 rounded-full hover:bg-neutral-700 text-neutral-400 hover:text-white transition-all material-symbols-outlined" @onclick="SelectAll" title="Tümünü Seç">select_all</button>
                    <div class="h-6 w-px bg-neutral-700"></div>
                    <button class="p-3 rounded-full hover:bg-neutral-700 text-neutral-400 hover:text-white transition-all material-symbols-outlined" @onclick="ClearResult" title="Temizle">refresh</button>
                </div>
            }
        </section>

        <!-- Right Panel: Export & Save -->
        <aside class="w-[280px] border-l border-neutral-700 bg-background-dark flex flex-col p-6 space-y-6 z-20">
            
            <!-- Aspect Ratio -->
            <div>
                <h3 class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-4">En Boy Oranı</h3>
                <div class="grid grid-cols-2 gap-2">
                    @foreach (var ratio in aspectRatios)
                    {
                        <button class="flex flex-col items-center gap-1.5 p-3 rounded-lg border-2 @(selectedAspectRatio == ratio.Key ? "border-primary bg-primary/5" : "border-neutral-700 bg-neutral-800/50 hover:border-neutral-600") transition-all"
                                @onclick="() => selectedAspectRatio = ratio.Key">
                            <span class="material-symbols-outlined text-sm @(selectedAspectRatio == ratio.Key ? "text-primary" : "text-neutral-500")">@ratio.Value.Icon</span>
                            <span class="text-[10px] font-bold uppercase tracking-wider @(selectedAspectRatio == ratio.Key ? "text-primary" : "text-neutral-400")">@ratio.Key</span>
                            <span class="text-[8px] text-neutral-500 tracking-wide">@ratio.Value.Platform</span>
                        </button>
                    }
                </div>
            </div>

            <!-- Export Format -->
            <div>
                <h3 class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-4">Dışa Aktarma Formatı</h3>
                <div class="grid grid-cols-3 gap-2">
                    @foreach (var fmt in exportFormats)
                    {
                        <button class="p-2 rounded-lg border @(selectedExportFormat == fmt ? "border-primary bg-primary/10 text-primary" : "border-neutral-700 bg-neutral-800/50 text-neutral-400 hover:border-neutral-600") text-[10px] font-bold uppercase tracking-wider transition-all"
                                @onclick="() => selectedExportFormat = fmt">
                            @fmt
                        </button>
                    }
                </div>
            </div>

            <!-- Resolution -->
            <div>
                <h3 class="text-xs font-bold text-neutral-400 uppercase tracking-[0.2em] mb-4">Çözünürlük</h3>
                <select @bind="selectedResolution" class="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-sm text-white outline-none focus:border-primary uppercase tracking-wider">
                    <option value="original">Orijinal</option>
                    <option value="1080p">1080p (1080×1440)</option>
                    <option value="4k">4K (2160×2880)</option>
                </select>
            </div>

             <!-- Error Message Display -->
             @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
                    <p class="text-[10px] text-red-400">@errorMessage</p>
                </div>
            }

            <div class="mt-auto space-y-3">
                <button class="w-full flex items-center justify-between px-4 py-3 rounded-lg border border-neutral-700 hover:bg-neutral-800 transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                        disabled="@(!selectedImageIndices.Any())"
                        @onclick="SaveSelection">
                    <span class="text-xs font-bold tracking-widest uppercase">Seçimi Kaydet</span>
                    <span class="material-symbols-outlined text-sm">bookmark</span>
                </button>
                <button class="w-full flex items-center justify-between px-4 py-3 rounded-lg bg-neutral-800 border border-neutral-700 hover:border-neutral-600 transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                        disabled="@(!selectedImageIndices.Any())"
                        @onclick="ExportAssets">
                    <span class="text-xs font-bold tracking-widest uppercase">
                        Dışa Aktar @(selectedImageIndices.Count > 0 ? $"({selectedImageIndices.Count})" : "")
                    </span>
                    <span class="material-symbols-outlined text-sm text-primary">download</span>
                </button>
            </div>
        </aside>
    </main>
    
    <!-- Bottom Bar: Status -->
    <footer class="h-8 border-t border-neutral-700 bg-background-dark flex items-center justify-between px-6 text-[10px] text-neutral-500 uppercase tracking-widest z-50">
        <div class="flex items-center gap-4">
             <span class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Motor Hazır</span>
            <span class="h-3 w-px bg-neutral-700"></span>
            <span>NanoBanana Pro</span>
        </div>
        <div class="flex items-center gap-4">
             <span>Format: @selectedExportFormat</span>
            <span class="h-3 w-px bg-neutral-700"></span>
            <span>Oran: @selectedAspectRatio</span>
        </div>
    </footer>
</div>

@code {
    // State
    private string? uploadedClothingUrl;
    private string? selectedModelId;
    private string? selectedBackground = "Studio Minimal";
    private string? selectedLighting = "Golden Hour";
    private string selectedCategory = "upper_body";
    private string selectedPose = "Ayakta";
    private string selectedAspectRatio = "3:4";
    private string selectedExportFormat = "JPG";
    private string selectedResolution = "original";
    private List<string> generatedImages = new();
    private HashSet<int> selectedImageIndices = new();
    private string? errorMessage;
    private bool isProcessing;
    private int variationCount = 4;
    private List<Giydir.Core.Entities.Pose> loadedPoses = new();
    private List<Giydir.Core.Entities.ModelAsset> loadedModels = new();

    // Options
    private readonly Dictionary<string, string> vibeOptions = new()
    {
        { "Studio Minimal", "background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);" },
        { "Urban Cinematic", "background: linear-gradient(135deg, #2d1b00 0%, #4a3728 40%, #1a1a1a 100%);" },
        { "Architectural Luxury", "background: linear-gradient(135deg, #2c3e50 0%, #bdc3c7 50%, #ecf0f1 100%);" },
        { "Nature Organic", "background: linear-gradient(135deg, #0b3d0b 0%, #1b5e20 50%, #2e7d32 100%);" },
        { "Sunset Warm", "background: linear-gradient(135deg, #bf360c 0%, #e65100 50%, #ff8f00 100%);" }
    };
    private readonly string[] exportFormats = { "JPG", "PNG", "WebP" };
    private readonly Dictionary<string, (string Icon, string Platform)> aspectRatios = new()
    {
        { "3:4", ("crop_3_2", "Genel") },
        { "4:5", ("photo_camera", "Instagram") },
        { "1:1", ("crop_square", "Kare") },
        { "16:9", ("crop_16_9", "Geniş") },
        { "9:16", ("smartphone", "Story / Reels") },
        { "2:3", ("push_pin", "Pinterest") },
        { "1200:628", ("storefront", "Shopify") }
    };
    
    private bool CanGenerate => 
        !isProcessing && !string.IsNullOrEmpty(uploadedClothingUrl) && !string.IsNullOrEmpty(selectedModelId);

    protected override async Task OnInitializedAsync()
    {
        loadedPoses = await PoseRepository.GetAllActiveAsync();
        if (loadedPoses.Any() && !loadedPoses.Any(p => p.Name == selectedPose))
        {
            selectedPose = loadedPoses.First().Name;
        }

        loadedModels = await ModelAssetRepository.GetAllAsync();
        if (string.IsNullOrEmpty(selectedModelId) && loadedModels.Any())
        {
            selectedModelId = loadedModels.First().Id;
        }
    }

    // --- Image Selection ---
    private void ToggleImageSelection(int index)
    {
        if (!selectedImageIndices.Remove(index))
            selectedImageIndices.Add(index);
    }

    private void SelectAll()
    {
        if (selectedImageIndices.Count == generatedImages.Count)
            selectedImageIndices.Clear();
        else
            selectedImageIndices = Enumerable.Range(0, generatedImages.Count).ToHashSet();
    }

    // --- Upload ---
    private async Task HandleClothingUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file.Size > 10 * 1024 * 1024) return;

        try
        {
            using var content = new MultipartFormDataContent();
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var streamContent = new StreamContent(stream);
            streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
            content.Add(streamContent, "file", file.Name);

            var response = await Http.PostAsync("/api/upload/clothing", content);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<UploadResponseDto>();
                uploadedClothingUrl = result?.Url;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Upload Error");
        }
    }

    // --- Generate ---
    private async Task GenerateImage()
    {
        if (!CanGenerate) return;

        isProcessing = true;
        errorMessage = null;
        generatedImages.Clear();
        selectedImageIndices.Clear();

        try
        {
            var request = new FashionRenderRequest
            {
                ProductCategory = selectedCategory,
                Fit = "regular",
                Color = "original",
                Vibe = selectedBackground,
                ModelId = selectedModelId!,
                SourceImageUrl = uploadedClothingUrl,
                PositivePrompt = "", // Will be set below
                NumberOfImages = variationCount
            };
            
            var selectedModel = loadedModels.FirstOrDefault(m => m.Id == selectedModelId);
            
            // Build intelligent prompt
            var modelDesc = !string.IsNullOrEmpty(selectedModel?.TriggerWord) 
                ? selectedModel.TriggerWord 
                : (selectedModel?.Gender == "Male" ? "male model" : "female model");
                
            var categoryDesc = selectedCategory switch 
            {
                "upper_body" => "upper body garment",
                "lower_body" => "lower body garment",
                "dresses" => "dress",
                _ => "clothing"
            };

            var prompt = $"{modelDesc} wearing {categoryDesc}, posing in {selectedPose}, standing in {selectedBackground}, {selectedLighting} lighting, highly detailed face, realistic skin texture, photorealistic, 8k uhd, cinematic lighting";
            
            request.PositivePrompt = prompt;

            if (selectedModel != null)
            {
                request.ModelImageUrl = selectedModel.FullImagePath;
            }

            var predictionIds = await Orchestrator.GenerateFashionSetAsync(request);

            if (predictionIds.Any())
            {
                 await PollForFashionSet(predictionIds);
            }
            else 
            {
                 errorMessage = "Could not start generation jobs.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Generation Error");
            errorMessage = "An error occurred during generation.";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task PollForFashionSet(List<string> predictionIds)
    {
        var pendingIds = new HashSet<string>(predictionIds);
        var maxAttempts = 60;
        
        Logger.LogInformation("Polling started for {Count} predictions: {Ids}", pendingIds.Count, string.Join(", ", pendingIds));
        
        for (int i = 0; i < maxAttempts; i++)
        {
            if (pendingIds.Count == 0) break;

            foreach (var id in pendingIds.ToList())
            {
                try
                {
                    var status = await GenService.CheckStatusAsync(id);
                    Logger.LogInformation("Poll attempt {Attempt} - Prediction {Id}: Status={Status}, OutputUrl={Output}", 
                        i + 1, id, status.Status, status.OutputUrl ?? "null");
                    
                    if (status.Status == "succeeded" && !string.IsNullOrEmpty(status.OutputUrl))
                    {
                        generatedImages.Add(status.OutputUrl);
                        pendingIds.Remove(id);
                        await InvokeAsync(StateHasChanged);
                        Logger.LogInformation("✅ Prediction {Id} succeeded, image added. Remaining: {Count}", id, pendingIds.Count);
                    }
                    else if (status.Status == "failed" || status.Status == "canceled")
                    {
                        Logger.LogWarning("❌ Prediction {Id} {Status}: {Error}", id, status.Status, status.Error ?? "no error");
                        pendingIds.Remove(id);
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error checking status for prediction {Id}", id);
                    pendingIds.Remove(id);
                }
            }
            
            if (pendingIds.Count > 0) await Task.Delay(2000);
        }
        
        Logger.LogInformation("Polling finished. Total images: {Count}", generatedImages.Count);
    }

    // --- Export ---
    private async Task ExportAssets()
    {
        if (!selectedImageIndices.Any()) return;

        try
        {
            var urls = selectedImageIndices.OrderBy(i => i).Select(i => generatedImages[i]).ToList();
            
            if (urls.Count == 1)
            {
                // Single image: direct download
                await JS.InvokeVoidAsync("downloadImage", urls[0], $"giydir_export.{selectedExportFormat.ToLower()}");
            }
            else
            {
                // Multiple: download each
                for (int i = 0; i < urls.Count; i++)
                {
                    await JS.InvokeVoidAsync("downloadImage", urls[i], $"giydir_export_{i + 1}.{selectedExportFormat.ToLower()}");
                    await Task.Delay(500); // Small delay between downloads
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Export Error");
            errorMessage = "Export failed.";
        }
    }

    // --- Save ---
    private async Task SaveSelection()
    {
        if (!selectedImageIndices.Any()) return;

        try
        {
            // Get user ID from JWT token stored in localStorage
            var token = await JS.InvokeAsync<string>("tokenStorage.getToken");
            if (string.IsNullOrEmpty(token))
            {
                errorMessage = "Kaydetmek için giriş yapmalısınız.";
                return;
            }
            var principal = JwtService.ValidateToken(token);
            var userIdStr = principal?.FindFirst("sub")?.Value;
            if (!int.TryParse(userIdStr, out var userId))
            {
                errorMessage = "Oturum süresi dolmuş, lütfen tekrar giriş yapın.";
                return;
            }

            // Prompt for project name
            var projectName = await JS.InvokeAsync<string>("prompt", "Proje adı girin:", $"Proje {DateTime.Now:dd.MM.yyyy HH:mm}");
            if (string.IsNullOrWhiteSpace(projectName))
            {
                return; // User cancelled
            }

            var urls = selectedImageIndices.OrderBy(i => i).Select(i => generatedImages[i]).ToList();

            // Always create a new unique project
            var newProject = new Project { UserId = userId, Name = projectName.Trim() };
            var created = await ProjectRepository.CreateAsync(newProject);
            int projectId = created.Id;

            int savedCount = 0;
            foreach (var imageUrl in urls)
            {
                try
                {
                    string localPath;
                    try
                    {
                        localPath = await ImageDownloader.DownloadAndSaveAsync(imageUrl, $"saved_{Guid.NewGuid():N}.jpg");
                    }
                    catch
                    {
                        localPath = imageUrl;
                    }

                    var generatedImage = new GeneratedImage
                    {
                        ProjectId = projectId,
                        OriginalClothingPath = uploadedClothingUrl ?? "editor",
                        ModelAssetId = selectedModelId ?? "editor-saved",
                        GeneratedImagePath = localPath,
                        Status = "Completed"
                    };
                    await ImageRepository.CreateAsync(generatedImage);
                    savedCount++;
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Görsel kaydedilemedi: {Url}", imageUrl);
                }
            }

            if (savedCount > 0)
            {
                errorMessage = null;
                await JS.InvokeVoidAsync("alert", $"'{projectName}' projesine {savedCount} görsel kaydedildi!");
            }
            else
            {
                errorMessage = "Görseller kaydedilemedi.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Kaydetme hatası");
            errorMessage = "Kaydetme sırasında bir hata oluştu.";
        }
    }

    // --- Clear ---
    private void ClearClothing()
    {
        uploadedClothingUrl = null;
    }

    private void ClearResult()
    {
        generatedImages.Clear();
        selectedImageIndices.Clear();
        errorMessage = null;
    }
}
