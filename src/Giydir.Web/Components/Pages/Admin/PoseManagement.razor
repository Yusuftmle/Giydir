@page "/admin/pose-management"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@using Giydir.Core.Entities
@using Giydir.Core.Interfaces
@inject IPoseRepository PoseRepository
@inject IAIImageGenerationService AIService
@inject IImageDownloadService ImageDownloader
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<PoseManagement> Logger
@rendermode InteractiveServer

<div class="p-8 space-y-8">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold tracking-tight">Poz Yönetimi</h2>
            <p class="text-sm text-slate-400 mt-1">Editördeki poz seçeneklerini yönetin — AI ile poz fotoğrafı üretin</p>
        </div>
        <button @onclick="ShowCreateForm" class="bg-primary text-background-dark px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-widest hover:brightness-110 transition-all flex items-center gap-2">
            <span class="material-icons text-sm">add</span>
            Yeni Poz Ekle
        </button>
    </div>

    @if (showForm)
    {
        <div class="bg-panel-dark border border-white/5 rounded-2xl p-6 space-y-5">
            <h3 class="text-sm font-bold uppercase tracking-widest text-primary">@(editingPose != null ? "Pozu Düzenle" : "Yeni Poz Oluştur")</h3>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block tracking-wider">Poz Adı</label>
                    <input @bind="formName" type="text" placeholder="ör. Ayakta, Rahat, Editorial" 
                           class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-sm focus:ring-1 focus:ring-primary outline-none text-white" />
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block tracking-wider">Sıralama</label>
                    <input @bind="formSortOrder" type="number" min="0" 
                           class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-sm focus:ring-1 focus:ring-primary outline-none text-white" />
                </div>
            </div>

            <div>
                <label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block tracking-wider">
                    Prompt Kelimesi <span class="text-slate-600 normal-case">(AI fashion render'a gönderilen metin)</span>
                </label>
                <input @bind="formPromptKeyword" type="text" placeholder="ör. standing pose, straight posture, arms at sides" 
                       class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-sm focus:ring-1 focus:ring-primary outline-none text-white" />
            </div>

            <!-- AI Pose Photo Generation -->
            <div class="bg-primary/5 border border-primary/20 rounded-xl p-5 space-y-3">
                <div class="flex items-center gap-2 mb-1">
                    <span class="material-icons text-primary text-sm">auto_fix_high</span>
                    <label class="text-[10px] uppercase font-bold text-primary tracking-wider">AI ile Poz Fotoğrafı Üret</label>
                </div>
                <p class="text-[10px] text-slate-500 leading-relaxed">
                    Sadece pozu tarif edin — sistem otomatik olarak "moda modeli poz referans fotoğrafı" bağlamını ekler.
                </p>
                <div class="flex gap-3">
                    <input @bind="formGeneratePrompt" type="text" 
                           placeholder="ör. kadın modeli düz duruyor, kollar yanda, kendinden emin bakış" 
                           class="flex-1 bg-black/30 border border-primary/20 rounded-xl p-3 text-sm focus:ring-1 focus:ring-primary outline-none text-white placeholder:text-slate-600" />
                    <button @onclick="GeneratePosePhoto" disabled="@isGenerating"
                            class="bg-primary text-background-dark px-5 py-3 rounded-xl text-xs font-bold uppercase tracking-widest hover:brightness-110 transition-all disabled:opacity-50 flex items-center gap-2 whitespace-nowrap">
                        @if (isGenerating)
                        {
                            <span class="animate-spin material-icons text-sm">refresh</span>
                            <span>Üretiliyor...</span>
                        }
                        else
                        {
                            <span class="material-icons text-sm">auto_fix_high</span>
                            <span>Üret</span>
                        }
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(generationStatus))
                {
                    <div class="flex items-center gap-2 text-[10px] uppercase tracking-widest @(generationStatus.Contains("Hata") ? "text-red-400" : "text-primary")">
                        @if (isGenerating)
                        {
                            <span class="animate-ping w-2 h-2 rounded-full bg-primary inline-block"></span>
                        }
                        <span>@generationStatus</span>
                    </div>
                }
            </div>

            <!-- Current / Generated Photo Preview -->
            @if (!string.IsNullOrEmpty(formImagePath))
            {
                <div class="flex items-center gap-4">
                    <img src="@formImagePath" class="w-24 h-32 object-cover rounded-lg border border-white/10" alt="Poz önizleme" />
                    <div class="space-y-2">
                        <p class="text-[10px] text-slate-500 uppercase tracking-wider">Mevcut Fotoğraf</p>
                        <button @onclick="() => formImagePath = string.Empty" class="text-red-400 hover:text-red-300 text-xs uppercase tracking-wider">Kaldır</button>
                    </div>
                </div>
            }

            <!-- Manual Upload (fallback) -->
            <div>
                <label class="text-[10px] uppercase font-bold text-slate-600 mb-2 block tracking-wider">Veya Manuel Yükle</label>
                <div class="relative">
                    <InputFile OnChange="HandlePoseImageUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/jpeg,image/png,image/webp" />
                    <div class="flex items-center gap-2 bg-black/10 border border-white/5 rounded-xl p-3 text-sm text-slate-500 cursor-pointer hover:border-primary/30 transition-colors">
                        <span class="material-icons text-sm">upload</span>
                        <span>Dosyadan fotoğraf yükle</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button @onclick="SavePose" disabled="@isSaving" class="bg-primary text-background-dark px-6 py-3 rounded-xl text-xs font-bold uppercase tracking-widest hover:brightness-110 transition-all disabled:opacity-50">
                    @(isSaving ? "Kaydediliyor..." : "Kaydet")
                </button>
                <button @onclick="CancelForm" class="bg-white/5 border border-white/10 text-white px-6 py-3 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-white/10 transition-all">
                    İptal
                </button>
            </div>
        </div>
    }

    <!-- Pose List -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        @foreach (var pose in poses)
        {
            <div class="group relative bg-panel-dark border border-white/5 rounded-2xl overflow-hidden hover:border-primary/30 transition-all">
                <div class="aspect-[3/4] bg-black/20 relative">
                    @if (!string.IsNullOrEmpty(pose.ImagePath))
                    {
                        <img src="@pose.ImagePath" class="w-full h-full object-cover" alt="@pose.Name" />
                    }
                    else
                    {
                        <div class="w-full h-full flex items-center justify-center">
                            <span class="material-icons text-4xl text-slate-600">image</span>
                        </div>
                    }
                    
                    @if (!pose.IsActive)
                    {
                        <div class="absolute inset-0 bg-black/60 flex items-center justify-center">
                            <span class="text-[10px] font-bold uppercase tracking-widest text-red-400">Pasif</span>
                        </div>
                    }

                    <!-- Action buttons -->
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button @onclick="() => EditPose(pose)" class="w-8 h-8 bg-black/60 backdrop-blur-sm rounded-lg flex items-center justify-center hover:bg-primary/30 transition-colors">
                            <span class="material-icons text-sm text-white">edit</span>
                        </button>
                        <button @onclick="() => ToggleActive(pose)" class="w-8 h-8 bg-black/60 backdrop-blur-sm rounded-lg flex items-center justify-center hover:bg-yellow-500/30 transition-colors">
                            <span class="material-icons text-sm text-white">@(pose.IsActive ? "visibility_off" : "visibility")</span>
                        </button>
                        <button @onclick="() => DeletePose(pose.Id)" class="w-8 h-8 bg-black/60 backdrop-blur-sm rounded-lg flex items-center justify-center hover:bg-red-500/30 transition-colors">
                            <span class="material-icons text-sm text-white">delete</span>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <h4 class="text-sm font-bold text-white">@pose.Name</h4>
                    <p class="text-[10px] text-slate-500 mt-1 uppercase tracking-wider truncate" title="@pose.PromptKeyword">@pose.PromptKeyword</p>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-[9px] text-slate-600">Sıra: @pose.SortOrder</span>
                        <span class="w-2 h-2 rounded-full @(pose.IsActive ? "bg-emerald-500" : "bg-red-500")"></span>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (!poses.Any())
    {
        <div class="text-center py-20 opacity-30">
            <span class="material-icons text-5xl">photo_library</span>
            <p class="text-sm mt-4 uppercase tracking-widest font-bold">Henüz poz eklenmemiş</p>
        </div>
    }
</div>

@code {
    private List<Pose> poses = new();
    private bool showForm = false;
    private bool isSaving = false;
    private bool isGenerating = false;
    private string generationStatus = string.Empty;
    private Pose? editingPose;

    // Form fields
    private string formName = string.Empty;
    private string formImagePath = string.Empty;
    private string formPromptKeyword = string.Empty;
    private string formGeneratePrompt = string.Empty;
    private int formSortOrder = 0;

    // Auto-prepended system context for pose generation
    private const string PoseSystemPrefix = "Professional fashion model pose reference photograph, full body shot, clean white studio background, studio lighting, high fashion editorial style, ";

    protected override async Task OnInitializedAsync()
    {
        await LoadPoses();
    }

    private async Task LoadPoses()
    {
        poses = await PoseRepository.GetAllAsync();
    }

    private void ShowCreateForm()
    {
        editingPose = null;
        formName = string.Empty;
        formImagePath = string.Empty;
        formPromptKeyword = string.Empty;
        formGeneratePrompt = string.Empty;
        formSortOrder = poses.Count + 1;
        showForm = true;
    }

    private void EditPose(Pose pose)
    {
        editingPose = pose;
        formName = pose.Name;
        formImagePath = pose.ImagePath;
        formPromptKeyword = pose.PromptKeyword;
        formGeneratePrompt = string.Empty;
        formSortOrder = pose.SortOrder;
        showForm = true;
    }

    private void CancelForm()
    {
        showForm = false;
        editingPose = null;
        generationStatus = string.Empty;
    }

    // --- AI Pose Photo Generation ---
    private async Task GeneratePosePhoto()
    {
        if (string.IsNullOrWhiteSpace(formGeneratePrompt))
        {
            generationStatus = "⚠️ Lütfen bir poz açıklaması girin.";
            return;
        }

        isGenerating = true;
        generationStatus = "Poz fotoğrafı üretiliyor...";
        StateHasChanged();

        try
        {
            // Build the full prompt: system prefix + user's pose description
            var fullPrompt = PoseSystemPrefix + formGeneratePrompt.Trim();

            Logger.LogInformation("Generating pose photo with prompt: {Prompt}", fullPrompt);

            // Create a FashionRenderRequest to use the existing NanoBanana pipeline
            var request = new Giydir.Core.DTOs.FashionRenderRequest
            {
                ProductCategory = "pose_reference",
                Fit = "regular",
                Color = "original",
                Vibe = "Studio Minimal",
                ModelId = "pose-gen", // dummy, won't be used since PositivePrompt overrides
                PositivePrompt = fullPrompt,
                NegativePrompt = "deformed, blurry, low quality, cropped, multiple people, text, watermark, logo",
                Width = 768,
                Height = 1024,
                NumberOfImages = 1
            };

            var predictionId = await AIService.GenerateAsync(request);
            generationStatus = "AI işliyor... (bu 30-60 saniye sürebilir)";
            StateHasChanged();

            // Poll for result
            var maxAttempts = 60; // 60 x 3s = 3 minutes
            for (int i = 0; i < maxAttempts; i++)
            {
                await Task.Delay(3000);
                var status = await AIService.CheckStatusAsync(predictionId);

                if (status.Status == "succeeded" && !string.IsNullOrEmpty(status.OutputUrl))
                {
                    generationStatus = "Fotoğraf indiriliyor...";
                    StateHasChanged();

                    // Download and save locally
                    var savedPath = await DownloadAndSavePoseImage(status.OutputUrl);
                    if (!string.IsNullOrEmpty(savedPath))
                    {
                        formImagePath = savedPath;
                        generationStatus = "✅ Poz fotoğrafı başarıyla üretildi!";
                    }
                    else
                    {
                        generationStatus = "⚠️ Fotoğraf indirilemedi, URL: " + status.OutputUrl;
                    }
                    StateHasChanged();
                    return;
                }
                else if (status.Status == "failed")
                {
                    generationStatus = $"❌ Hata: {status.Error ?? "Bilinmeyen hata"}";
                    StateHasChanged();
                    return;
                }
                else if (status.Status == "canceled")
                {
                    generationStatus = "❌ Üretim iptal edildi.";
                    StateHasChanged();
                    return;
                }

                generationStatus = $"AI işliyor... ({(i + 1) * 3} sn)";
                StateHasChanged();
            }

            generationStatus = "⚠️ Zaman aşımı — lütfen tekrar deneyin.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Pose photo generation failed");
            generationStatus = $"❌ Hata: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task<string?> DownloadAndSavePoseImage(string imageUrl)
    {
        try
        {
            var uploadsDir = Path.Combine("wwwroot", "uploads", "poses");
            Directory.CreateDirectory(uploadsDir);

            var fileName = $"pose_{DateTime.UtcNow:yyyyMMddHHmmss}_{Guid.NewGuid().ToString()[..6]}.jpg";
            var filePath = Path.Combine(uploadsDir, fileName);

            using var httpClient = new HttpClient();
            var imageBytes = await httpClient.GetByteArrayAsync(imageUrl);
            await File.WriteAllBytesAsync(filePath, imageBytes);

            Logger.LogInformation("Pose image saved: {Path} ({Size} bytes)", filePath, imageBytes.Length);
            return $"/uploads/poses/{fileName}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to download pose image from {Url}", imageUrl);
            return null;
        }
    }

    // --- Manual Upload (fallback) ---
    private async Task HandlePoseImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file.Size > 5 * 1024 * 1024) return;

        try
        {
            var uploadsDir = Path.Combine("wwwroot", "uploads", "poses");
            Directory.CreateDirectory(uploadsDir);

            var fileName = $"pose_{DateTime.UtcNow:yyyyMMddHHmmss}_{Guid.NewGuid().ToString()[..6]}{Path.GetExtension(file.Name)}";
            var filePath = Path.Combine(uploadsDir, fileName);

            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var fileStream = new FileStream(filePath, FileMode.Create);
            await stream.CopyToAsync(fileStream);

            formImagePath = $"/uploads/poses/{fileName}";
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Yükleme hatası: {ex.Message}");
        }
    }

    // --- CRUD ---
    private async Task SavePose()
    {
        if (string.IsNullOrWhiteSpace(formName)) 
        {
            await JSRuntime.InvokeVoidAsync("alert", "Poz adı zorunludur.");
            return;
        }

        isSaving = true;
        try
        {
            if (editingPose != null)
            {
                editingPose.Name = formName;
                editingPose.ImagePath = formImagePath;
                editingPose.PromptKeyword = formPromptKeyword;
                editingPose.SortOrder = formSortOrder;
                await PoseRepository.UpdateAsync(editingPose);
            }
            else
            {
                var pose = new Pose
                {
                    Name = formName,
                    ImagePath = formImagePath,
                    PromptKeyword = formPromptKeyword,
                    SortOrder = formSortOrder,
                    IsActive = true,
                    CreatedAt = DateTime.UtcNow
                };
                await PoseRepository.CreateAsync(pose);
            }

            showForm = false;
            editingPose = null;
            generationStatus = string.Empty;
            await LoadPoses();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Kaydetme hatası: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ToggleActive(Pose pose)
    {
        pose.IsActive = !pose.IsActive;
        await PoseRepository.UpdateAsync(pose);
        await LoadPoses();
    }

    private async Task DeletePose(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Bu pozu silmek istediğinize emin misiniz?");
        if (confirmed)
        {
            await PoseRepository.DeleteAsync(id);
            await LoadPoses();
        }
    }
}
