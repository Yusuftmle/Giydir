@using Giydir.Core.Entities
@using Giydir.Core.Interfaces
@inject IModelAssetRepository ModelAssetRepository

@if (isLoading)
{
    <div class="flex items-center justify-center py-12">
        <div class="relative w-12 h-12">
            <div class="absolute inset-0 border-4 border-gray-700 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-primary rounded-full border-t-transparent animate-spin"></div>
        </div>
    </div>
}
else if (models.Count == 0)
{
    <div class="text-center py-12 text-gray-400">
        <span class="material-icons-outlined text-4xl">person_off</span>
        <p class="mt-3 text-sm">Henüz model pozu eklenmemiş</p>
    </div>
}
else
{
    <!-- Filter Chips -->
    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-4">
        <button class="flex-none px-4 py-1.5 rounded-full text-sm transition-all @(genderFilter == "All" ? "bg-primary text-background-dark font-medium shadow-sm" : "bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary")"
                @onclick='() => genderFilter = "All"'>Tüm Modeller</button>
        <button class="flex-none px-4 py-1.5 rounded-full text-sm transition-all @(genderFilter == "Female" ? "bg-primary text-background-dark font-medium shadow-sm" : "bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary")"
                @onclick='() => genderFilter = "Female"'>Kadın</button>
        <button class="flex-none px-4 py-1.5 rounded-full text-sm transition-all @(genderFilter == "Male" ? "bg-primary text-background-dark font-medium shadow-sm" : "bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary")"
                @onclick='() => genderFilter = "Male"'>Erkek</button>
    </div>

    <!-- Model Grid -->
    <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        @foreach (var model in FilteredModels)
        {
            @if (model.Id == SelectedModelId)
            {
                <!-- Selected Model Card -->
                <div class="group relative aspect-[3/4] rounded-xl overflow-hidden cursor-pointer ring-4 ring-primary shadow-xl shadow-primary/20"
                     @onclick="() => SelectModel(model.Id)">
                    <div class="w-full h-full bg-gradient-to-br from-primary/20 to-blue-600/20 flex items-center justify-center">
                        <span class="material-icons-outlined text-4xl text-primary/60">person</span>
                    </div>
                    <img src="@model.ThumbnailPath" class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 z-10" alt="@model.Name"
                         onerror="this.style.display='none'; this.parentElement.querySelector('div').style.display='flex';" loading="lazy" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-90"></div>
                    <div class="absolute top-3 right-3 bg-primary text-background-dark rounded-full p-1 shadow-lg">
                        <span class="material-icons-outlined text-sm font-bold block">check</span>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full p-4">
                        <p class="text-white font-bold text-lg leading-tight m-0">@model.Name</p>
                        <p class="text-gray-300 text-xs mt-0.5 m-0">@model.Category</p>
                    </div>
                </div>
            }
            else
            {
                <!-- Normal Model Card -->
                <div class="group relative aspect-[3/4] rounded-xl overflow-hidden cursor-pointer bg-gray-200 dark:bg-gray-800 hover:ring-2 hover:ring-primary/50 transition-all"
                     @onclick="() => SelectModel(model.Id)">
                    <div class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center">
                        <span class="material-icons-outlined text-4xl text-gray-600">person</span>
                    </div>
                    <img src="@model.ThumbnailPath" class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 z-10" alt="@model.Name"
                         onerror="this.style.display='none'; this.parentElement.querySelector('div').style.display='flex';" loading="lazy" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="absolute bottom-0 left-0 w-full p-4 translate-y-4 group-hover:translate-y-0 transition-transform duration-300 opacity-0 group-hover:opacity-100">
                        <p class="text-white font-bold text-lg leading-tight m-0">@model.Name</p>
                        <p class="text-gray-300 text-xs mt-0.5 m-0">@model.Category</p>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    [Parameter]
    public string? SelectedModelId { get; set; }

    [Parameter]
    public EventCallback<string?> SelectedModelIdChanged { get; set; }

    private List<ModelAsset> models = new();
    private bool isLoading = true;
    private string genderFilter = "All";

    private IEnumerable<ModelAsset> FilteredModels =>
        genderFilter == "All"
            ? models
            : models.Where(m => m.Gender == genderFilter);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            models = await ModelAssetRepository.GetAllAsync();
        }
        catch (Exception)
        {
            models = new List<ModelAsset>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SelectModel(string modelId)
    {
        SelectedModelId = modelId;
        await SelectedModelIdChanged.InvokeAsync(modelId);
    }
}
