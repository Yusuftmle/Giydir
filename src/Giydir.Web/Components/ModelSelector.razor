@using Giydir.Core.Entities
@using Giydir.Core.Interfaces
@inject IModelAssetRepository ModelAssetRepository

@if (isLoading)
{
    <div class="flex items-center justify-center py-12">
        <div class="relative w-12 h-12">
            <div class="absolute inset-0 border-4 border-slate-700 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-[#d4b38d] rounded-full border-t-transparent animate-spin"></div>
        </div>
    </div>
}
else if (models.Count == 0)
{
    <div class="text-center py-12 text-slate-400">
        <span class="material-symbols-outlined text-4xl">person_off</span>
        <p class="mt-3 text-sm">Henüz model pozu eklenmemiş</p>
    </div>
}
else
{
    <!-- Filter Chips -->
    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-4">
        <button class="flex-none px-4 py-1.5 rounded-full text-[10px] font-bold tracking-widest uppercase transition-all @(genderFilter == "All" ? "bg-white/5 text-[#d4b38d] border border-[#d4b38d]/30" : "bg-white/[0.02] border border-white/10 text-slate-500 hover:border-white/20")"
                @onclick='() => genderFilter = "All"'>All Models</button>
        <button class="flex-none px-4 py-1.5 rounded-full text-[10px] font-bold tracking-widest uppercase transition-all @(genderFilter == "Female" ? "bg-white/5 text-[#d4b38d] border border-[#d4b38d]/30" : "bg-white/[0.02] border border-white/10 text-slate-500 hover:border-white/20")"
                @onclick='() => genderFilter = "Female"'>Female</button>
        <button class="flex-none px-4 py-1.5 rounded-full text-[10px] font-bold tracking-widest uppercase transition-all @(genderFilter == "Male" ? "bg-white/5 text-[#d4b38d] border border-[#d4b38d]/30" : "bg-white/[0.02] border border-white/10 text-slate-500 hover:border-white/20")"
                @onclick='() => genderFilter = "Male"'>Male</button>
    </div>

    <!-- Model Grid - Horizontal Scroll -->
    <div @ref="scrollContainer" class="flex gap-4 overflow-x-auto no-scrollbar pb-2 cursor-grab active:cursor-grabbing">
        @foreach (var model in FilteredModels)
        {
            @if (model.Id == SelectedModelId)
            {
                <!-- Selected Model Card -->
                <div class="flex-none w-36 aspect-[3/4] rounded-xl overflow-hidden relative ring-2 ring-[#d4b38d] group cursor-pointer"
                     @onclick="() => SelectModel(model.Id)">
                    <img src="@model.ThumbnailPath" class="w-full h-full object-cover" alt="@model.Name"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" loading="lazy" />
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-700 to-slate-800 hidden items-center justify-center">
                        <span class="material-symbols-outlined text-4xl text-[#d4b38d]/60">person</span>
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-950/80 to-transparent"></div>
                    <div class="absolute bottom-3 left-3">
                        <p class="text-xs font-bold text-white tracking-wide">@model.Name</p>
                        <p class="text-[8px] text-[#d4b38d] uppercase font-bold tracking-widest mt-0.5">@model.Category</p>
                    </div>
                    <div class="absolute top-3 right-3">
                        <span class="material-symbols-outlined text-[#d4b38d] text-xl">check_circle</span>
                    </div>
                </div>
            }
            else
            {
                <!-- Normal Model Card -->
                <div class="flex-none w-36 aspect-[3/4] rounded-xl overflow-hidden relative glass-panel group cursor-pointer hover:border-[#d4b38d]/30 transition-all"
                     @onclick="() => SelectModel(model.Id)">
                    <img src="@model.ThumbnailPath" class="w-full h-full object-cover opacity-60 group-hover:opacity-90" alt="@model.Name"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" loading="lazy" />
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-700 to-slate-800 hidden items-center justify-center">
                        <span class="material-symbols-outlined text-4xl text-slate-600">person</span>
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-950/80 to-transparent"></div>
                    <div class="absolute bottom-3 left-3">
                        <p class="text-xs font-bold text-white tracking-wide">@model.Name</p>
                        <p class="text-[8px] text-slate-400 uppercase font-bold tracking-widest mt-0.5">@model.Category</p>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    [Parameter]
    public string? SelectedModelId { get; set; }

    [Parameter]
    public EventCallback<string?> SelectedModelIdChanged { get; set; }

    private List<ModelAsset> models = new();
    private bool isLoading = true;
    private string genderFilter = "All";

    private IEnumerable<ModelAsset> FilteredModels =>
        genderFilter == "All"
            ? models
            : models.Where(m => m.Gender == genderFilter);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            models = await ModelAssetRepository.GetAllAsync();
        }
        catch (Exception)
        {
            models = new List<ModelAsset>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private ElementReference scrollContainer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupHorizontalScroll", scrollContainer);
        }
    }

    private async Task SelectModel(string? modelId)
    {
        SelectedModelId = modelId;
        await SelectedModelIdChanged.InvokeAsync(modelId);
    }
}
@inject IJSRuntime JSRuntime
